document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("nav-analyze"),t=document.getElementById("nav-history"),n=document.getElementById("nav-sender"),s=document.getElementById("nav-settings"),r=(document.getElementById("view-analyze"),document.getElementById("view-history"),document.getElementById("view-sender"),document.getElementById("view-settings"),document.getElementById("analyze-btn")),a=document.getElementById("status"),o=document.getElementById("results"),i=document.getElementById("ai-history-container"),l=document.getElementById("clear-history-btn"),d=document.getElementById("sender-list-container"),c=document.getElementById("clear-sender-list-btn"),u=document.getElementById("sender-search-input"),m=document.getElementById("send-all-requests-btn"),y=document.getElementById("sender-all-status");let p=[],g="";const h=document.getElementById("ai-model-select"),v=document.querySelectorAll(".api-key-container"),b={gemini:document.getElementById("api-key-gemini"),chatgpt:document.getElementById("api-key-chatgpt"),deepseek:document.getElementById("api-key-deepseek"),doubao:document.getElementById("api-key-doubao")},E=document.getElementById("save-settings-btn"),L=document.getElementById("settings-status");function I(e){document.querySelectorAll(".view").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".nav button").forEach(e=>e.classList.remove("active"));const t=document.getElementById(`view-${e}`),n=document.getElementById(`nav-${e}`);t&&t.classList.add("active"),n&&n.classList.add("active"),"settings"===e?chrome.storage.sync.get({selectedModel:"gemini",apiKeyGemini:"",apiKeyChatGpt:"",apiKeyDeepSeek:"",apiKeyDoubao:""},e=>{h&&(h.value=e.selectedModel),b.gemini&&(b.gemini.value=e.apiKeyGemini),b.chatgpt&&(b.chatgpt.value=e.apiKeyChatGpt),b.deepseek&&(b.deepseek.value=e.apiKeyDeepSeek),b.doubao&&(b.doubao.value=e.apiKeyDoubao),h&&h.dispatchEvent(new Event("change")),console.log("Settings loaded:",e)}):"history"===e?x():"sender"===e&&f()}function x(){i&&(i.innerHTML="正在加载记录..."),chrome.storage.local.get({aiAnalysisHistory:[]},e=>{var t;t=e.aiAnalysisHistory,i&&(i.innerHTML="",t&&0!==t.length?t.slice().forEach((e,t)=>{const n=document.createElement("div");n.className="history-item",n.dataset.historyIndex=t;const s=e.timestamp?new Date(e.timestamp).toLocaleString():"未知时间",r=e.type?` (${e.type})`:"",a=e.sourceUrl?` on ${e.sourceUrl}`:"";e.result&&(e.result.substring(0,150),e.result.length),n.innerHTML=`\n                <div class="history-actions" style="float: right;">\n                    <button class="send-history-to-sender-btn secondary" data-history-index="${t}">发送全部到发包器</button>\n                    <button class="copy-history-btn secondary" data-full-result="${C(e.result||"")}">复制结果</button>\n                </div>\n                <div class="history-meta">${s}${r}${a}</div>\n                <details>\n                    <summary style="cursor: pointer; color: #555;">查看/隐藏 AI 分析结果</summary>\n                    <pre>${C(e.result||"[无结果]")}</pre>\n                </details>\n            `,i.appendChild(n)}):i.innerHTML='<p style="text-align: center; color: #888;">暂无分析记录。</p>')})}function f(){if(!d)return;d.innerHTML="";const e=p.filter(e=>{const t=g.toLowerCase();return!t||e.url.toLowerCase().includes(t)||e.method.toLowerCase().includes(t)});0!==e.length?e.forEach((e,t)=>{const n=document.createElement("div");n.className="sender-item",n.dataset.apiId=e.id,n.innerHTML=`\n                <div class="sender-grid">\n                    <label>Method:</label>\n                    <input type="text" class="sender-method-input" value="${C(e.method)}">\n                    <label>URL:</label>\n                    <input type="text" class="sender-url-input" value="${C(e.url)}">\n                    <label>Headers:</label>\n                    <textarea class="sender-headers-textarea" placeholder='请输入 JSON 格式的 Headers (例如 {"Authorization": "Bearer xxx"})'>${C(e.headers)}</textarea>\n                    <label>Body:</label>\n                    <textarea class="sender-body-textarea" placeholder='请输入 JSON 格式的 Body (GET 请求请留空)'>${C(e.body)}</textarea>\n                </div>\n                <button class="sender-item-send-btn primary">发送请求</button>\n                <hr>\n                <label>响应:</label>\n                <pre class="sender-response-pre">${e.response?C(e.response):"尚未请求"}</pre>\n            `,d.appendChild(n)}):d.innerHTML='<p style="text-align: center; color: #888;">列表为空，请从 AI 记录发送或手动添加。</p>'}async function S(e,t){const n=p.findIndex(t=>t.id===e);if(-1===n)return console.error("API not found in list:",e),{success:!1,error:"API not found"};const s=t.querySelector(".sender-url-input"),r=t.querySelector(".sender-method-input"),a=t.querySelector(".sender-headers-textarea"),o=t.querySelector(".sender-body-textarea"),i=t.querySelector(".sender-response-pre"),l=t.querySelector(".sender-item-send-btn");let d=s?s.value.trim():"";const c=r?r.value.trim().toUpperCase():"GET",u=a?a.value.trim():"{}",m=o?o.value.trim():"";if(p[n].url=d,p[n].method=c,p[n].headers=u,p[n].body=m,!d)return i&&(i.textContent="错误: URL 不能为空。"),{success:!1,error:"URL is empty"};let y=d;if(!d.startsWith("http://")&&!d.startsWith("https://"))if(d.startsWith("/"))try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e.length>0&&e[0].url))throw new Error("无法获取当前页面 Origin 来解析相对 URL。");{const t=new URL(e[0].url).origin;y=t+d,console.log(`[Sender] Converted relative URL "${d}" to absolute: "${y}"`)}}catch(e){return i&&(i.textContent=`错误: 无法解析相对 URL。\n${e.message}`),{success:!1,error:"Cannot resolve relative URL"}}else y="https://"+d,console.warn(`[Sender] URL "${d}" lacks protocol, assuming HTTPS: "${y}"`);let g={};if(u)try{g=JSON.parse(u)}catch(e){return i&&(i.textContent=`错误: Headers 不是有效的 JSON 格式。\n${e.message}`),{success:!1,error:"Invalid Headers JSON"}}const h={method:c,headers:g};if(m&&"GET"!==c&&"HEAD"!==c)try{JSON.parse(m),h.body=m,Object.keys(g).find(e=>"content-type"===e.toLowerCase())||(g["Content-Type"]="application/json;charset=UTF-8")}catch(e){h.body=m,Object.keys(g).find(e=>"content-type"===e.toLowerCase())}return i&&(i.textContent="请求发送中..."),l&&(l.disabled=!0),new Promise(e=>{chrome.runtime.sendMessage({type:"SEND_API_REQUEST",data:{url:y,options:h}},t=>{let s="";t&&"ok"===t.status?(s=`Status: ${t.statusCode} ${t.statusText}\n\n`+("object"==typeof t.data?JSON.stringify(t.data,null,2):String(t.data)),i&&(i.textContent=s),e({success:!0})):(s=`请求失败: ${t?t.error:"Unknown error"}`,i&&(i.textContent=s),e({success:!1,error:t?t.error:"Unknown error"})),p[n].response=s,l&&(l.disabled=!1)})})}function C(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}e.addEventListener("click",()=>I("analyze")),t.addEventListener("click",()=>I("history")),n.addEventListener("click",()=>I("sender")),s.addEventListener("click",()=>I("settings")),h&&h.addEventListener("change",()=>{const e=h.value;v.forEach(t=>{t.style.display=t.id.startsWith(e)?"block":"none"})}),E&&E.addEventListener("click",function(){const e={selectedModel:h?h.value:"gemini",apiKeyGemini:b.gemini?b.gemini.value.trim():"",apiKeyChatGpt:b.chatgpt?b.chatgpt.value.trim():"",apiKeyDeepSeek:b.deepseek?b.deepseek.value.trim():"",apiKeyDoubao:b.doubao?b.doubao.value.trim():""};chrome.storage.sync.set(e,()=>{console.log("Settings saved:",e),L&&(L.textContent="设置已保存！"),setTimeout(()=>{L&&(L.textContent="")},2e3)})}),r&&r.addEventListener("click",()=>{a&&(a.textContent="正在请求分析..."),o&&(o.textContent=""),r.disabled=!0,chrome.runtime.sendMessage({type:"START_ANALYSIS"})}),chrome.runtime.onMessage.addListener(e=>("ANALYSIS_STATUS"===e.type?a&&(a.textContent=e.text):"ANALYSIS_COMPLETE"===e.type?(a&&(a.textContent="分析完成！"),o&&(o.textContent=e.analysis),r&&(r.disabled=!1)):"ANALYSIS_ERROR"===e.type&&(a&&(a.textContent="分析出错！"),o&&(o.textContent=e.error),r&&(r.disabled=!1)),!0)),i&&i.addEventListener("click",e=>{const t=e.target,n=t.closest(".history-item");if(!n)return;const s=n.dataset.historyIndex;var r,a;t.classList.contains("copy-history-btn")?(r=t.dataset.fullResult,a=t,r&&a&&navigator.clipboard.writeText(r).then(()=>{const e=a.textContent;a.textContent="已复制!",a.disabled=!0,setTimeout(()=>{a.textContent=e,a.disabled=!1},1500)}).catch(e=>{console.error("复制失败:",e),alert("复制失败: "+e.message)})):t.classList.contains("send-history-to-sender-btn")&&chrome.storage.local.get({aiAnalysisHistory:[]},e=>{const t=e.aiAnalysisHistory[parseInt(s,10)];if(t&&t.result){const e=function(e){if(!e)return[];const t=[],n=/---\s*\*\*URL\*\*:.*?Body\)\*\*:[\s\S]*?```json\n([\s\S]*?)\n```/gs,s=/\*\*URL\*\*:.*?`([^`]+)`/,r=/\*\*Method\*\*:.*?`(\w+)`/;let a;for(;null!==(a=n.exec(e));){const e=a[0],n=a[1].trim(),o=e.match(s),i=e.match(r);if(o&&o[1]){const e=o[1].trim();if(e.startsWith("[")||e.includes("{"))continue;const s=i?i[1].trim().toUpperCase():"GET";let r={};["POST","PUT","PATCH"].includes(s)&&n&&"null"!==n&&(r["Content-Type"]="application/json;charset=UTF-8"),t.push({id:`api_${Date.now()}_${Math.random()}`,url:e,method:s,headers:JSON.stringify(r,null,2),body:"null"===n?"":n,response:null})}}return console.log("Parsed APIs:",t),t}(t.result);e.length>0?(n=e,p.unshift(...n),f(),I("sender"),alert(`已成功添加 ${e.length} 个 API 到发包器！`)):alert("未能从此记录中解析出有效的 API。")}else alert("无法加载此历史记录的数据。");var n})}),l&&l.addEventListener("click",()=>{confirm("确定要清空所有 AI 分析记录吗？此操作不可撤销。")&&chrome.storage.local.set({aiAnalysisHistory:[]},()=>{x(),console.log("AI history cleared.")})}),d&&d.addEventListener("click",e=>{if(e.target.classList.contains("sender-item-send-btn")){const t=e.target.closest(".sender-item");t&&S(t.dataset.apiId,t)}}),m&&m.addEventListener("click",async()=>{const e=d?d.querySelectorAll(".sender-item"):[];if(0===e.length)return void(y&&(y.textContent="列表为空。"));m.disabled=!0,m.textContent="请求中...";let t=0,n=0;for(let s=0;s<e.length;s++){const r=e[s],a=r.dataset.apiId,o=p.find(e=>e.id===a)?.url||"未知URL";y&&(y.textContent=`正在发送第 ${s+1} / ${e.length} 个请求... (${o})`),(await S(a,r)).success?t++:n++,s<e.length-1&&await new Promise(e=>setTimeout(e,300))}y&&(y.textContent=`全部 ${e.length} 个请求已发送完毕！成功 ${t} 个，失败 ${n} 个。`),m.disabled=!1,m.textContent="一键请求全部"}),c&&c.addEventListener("click",()=>{confirm("确定要清空发包器中的所有 API 吗？")&&(p=[],g="",u&&(u.value=""),f(),y&&(y.textContent="列表已清空。"))}),u&&u.addEventListener("input",()=>{g=u.value,f()}),I("analyze")});